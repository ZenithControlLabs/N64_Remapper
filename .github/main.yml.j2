# THIS FILE IS AUTOGENERATED BY A JINJA TEMPLATE
# IN THE PARENT DIRECTORY!!

name: Build and Upload

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  pull_request:

permissions:
  contents: write

jobs:

{% for config in buildconfigs %}
  build-{{config.name}}:  
    runs-on: ubuntu-latest
    container: xingrz/rpi-pico-builder:latest
    steps:

    - name: Install git
      run: |
        apt update
        apt install -y git
        
    - uses: actions/checkout@v3
      name: Clone N64 Remapper repo
      with:
        submodules: true

    - name: Clone Pico SDK
      uses: suisei-cn/actions-download-file@v1
      id: pico-sdk
      with:
        url: https://codeload.github.com/raspberrypi/pico-sdk/tar.gz/refs/tags/1.5.1
        target: assets

    - name: Clone TinyUSB 
      uses: suisei-cn/actions-download-file@v1
      id: tinyusb
      with:
        url: https://codeload.github.com/hathach/tinyusb/tar.gz/refs/tags/0.15.0
        target: assets

    - name: Untar Pico SDK
      run: |
        tar xvf assets/{% raw %}${{ steps.pico-sdk.outputs.filename }}{% endraw %} --transform 's/pico-sdk-1.5.1//' -C $PICO_SDK_PATH
        tar xvf assets/{% raw %}${{ steps.tinyusb.outputs.filename }}{% endraw %} --transform 's/tinyusb-0.15.0//' -C $PICO_SDK_PATH/lib/tinyusb

    - name: Configure CMake
      run: cmake -B build {{config.cmake_opts}}

    - name: Build
      # Build your program with the given configuration
      run: cmake --build build

    - name: Upload {{config.name}} UF2
      uses: actions/upload-artifact@v3
      with:
        name: {{config.name}}_uf2
        path: build/N64_Remapper.uf2
        if-no-files-found: error
{% endfor %}

  deploy:
    runs-on: ubuntu-latest
    needs:
{% for config in buildconfigs %}
      - build-{{config.name}}
{% endfor %}
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v3
        name: Clone N64 Remapper repo

      - uses: actions/download-artifact@v3
        name: Download UF2s

      - name: Move around files
        run: |
        {% for config in buildconfigs %}
          mv {{config.name}}_uf2/N64_Remapper.uf2 ./N64_Remapper_{% raw %}${{ github.ref_name }}{% endraw %}_{{config.name}}.uf2
        {% endfor %}

      - name: Push to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
            files: |
              {% for config in buildconfigs -%}
              N64_Remapper_{% raw %}${{ github.ref_name }}{% endraw %}_{{config.name}}.uf2
              {% endfor %}
